<%
  content_for :title, "My Business Listing"
  content_for :head do
%>
  <meta name="robots" content="noindex, nofollow">
<% end %>

<div class="company-directory-container">
  <header class="directory-header">
    <h1>My Business Listing</h1>
    <p>Manage your photography business listing in the UK Directory</p>
  </header>

  <% unless @can_create %>
    <div class="subscription-required">
      <div class="subscription-message">
        <div class="no-listings-icon">üîí</div>
        <h3>Subscription Required</h3>
        <p>You need an active subscription to create and manage a business listing.</p>
        <%= link_to "View Subscription Plans", "/", class: "btn btn-primary" %>
      </div>
    </div>
  <% else %>
    <% if @listing %>
      <!-- Existing Listing -->
      <div class="business-profile">
        <div class="business-header">
          <div class="business-title-section">
            <h2 class="business-name"><%= @listing.business_name %></h2>
            <div class="business-meta">
              <span class="category">
                üì∑ <%= @listing.category %>
              </span>
              <span class="location">
                üìç <%= @listing.city %>
              </span>
              <% if @listing.featured? %>
                <span class="featured-badge">
                  ‚≠ê Featured
                </span>
              <% end %>
              <% if @listing.approved? %>
                <span class="status-badge approved">
                  ‚úÖ Approved
                </span>
              <% else %>
                <span class="status-badge pending">
                  ‚è≥ Pending Approval
                </span>
              <% end %>
            </div>
          </div>

          <div class="business-actions">
            <%= link_to "View Public Profile", @listing.profile_url, class: "btn btn-primary", target: "_blank" %>
          </div>
        </div>

        <div class="listing-summary">
          <div class="summary-card">
            <h3>Listing Information</h3>

            <div class="info-grid">
              <div class="info-item">
                <strong>Business Name:</strong>
                <span><%= @listing.business_name %></span>
              </div>

              <div class="info-item">
                <strong>City:</strong>
                <span><%= @listing.city %></span>
              </div>

              <div class="info-item">
                <strong>Category:</strong>
                <span><%= @listing.category %></span>
              </div>

              <div class="info-item">
                <strong>Views:</strong>
                <span><%= @listing.views_count %> views</span>
              </div>

              <% if @listing.website.present? %>
                <div class="info-item">
                  <strong>Website:</strong>
                  <span><%= link_to @listing.website, @listing.website, target: "_blank", rel: "noopener" %></span>
                </div>
              <% end %>

              <% if @listing.email.present? %>
                <div class="info-item">
                  <strong>Email:</strong>
                  <span><%= @listing.email %></span>
                </div>
              <% end %>

              <% if @listing.phone.present? %>
                <div class="info-item">
                  <strong>Phone:</strong>
                  <span><%= @listing.phone %></span>
                </div>
              <% end %>
            </div>

            <div class="description-section">
              <h4>Description</h4>
              <p><%= directory_rich_text(@listing.description) %></p>
            </div>

            <% if @listing.image_urls.any? %>
              <div class="images-section">
                <h4>Portfolio Images (<%= @listing.image_urls.count %>)</h4>
                <div class="business-listing-images">
                  <% @listing.image_urls.first(6).each do |image_url| %>
                    <img src="<%= image_url %>" alt="<%= @listing.business_name %>" class="business-listing-image">
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if @listing.formatted_packages.any? %>
              <div class="packages-section">
                <h4>Packages (<%= @listing.formatted_packages.count %>)</h4>
                <div class="packages-list">
                  <% @listing.formatted_packages.each do |package| %>
                    <div class="package-item-summary">
                      <strong><%= package[:name] %></strong>
                      <% if package[:formatted_price] %>
                        <span class="package-price"><%= package[:formatted_price] %></span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="management-notice">
          <p>
            üìù <strong>Note:</strong> To edit your listing, please contact the site administrator or use the API endpoint at
            <code>PUT /my-business/<%= @listing.id %></code>
          </p>
          <p>
            For advanced management features, consider implementing a JavaScript-based management interface.
          </p>
        </div>
      </div>
    <% else %>
      <!-- No Listing Yet - Show Create Form -->
      <div class="create-listing-section">
        <div class="form-intro">
          <div class="no-listings-icon">üì∏</div>
          <h3>Create Your Business Listing</h3>
          <p>Fill out the form below to add your photography business to the UK Directory.</p>
        </div>

        <%= form_with(url: "/my-business", method: :post, class: "my-business-form", id: "create-listing-form") do |f| %>
          <div class="form-section">
            <h3>Basic Information</h3>

            <div class="form-row">
              <div class="form-field">
                <label for="business_name">Business Name *</label>
                <%= text_field_tag "business_listing[business_name]", nil, required: true, placeholder: "e.g. John Smith Photography" %>
              </div>

              <div class="form-field">
                <label for="category">Category *</label>
                <%= select_tag "business_listing[category]", options_for_select(@categories), required: true, prompt: "Select a category" %>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label for="city">City *</label>
                <%= select_tag "business_listing[city]", options_for_select(@cities), required: true, prompt: "Select a city" %>
              </div>

              <div class="form-field">
                <label for="website">Website</label>
                <%= text_field_tag "business_listing[website]", nil, type: "url", placeholder: "https://yourwebsite.com" %>
              </div>
            </div>

            <div class="form-row full-width">
              <div class="form-field">
                <label for="description">Description *</label>
                <%= text_area_tag "business_listing[description]", nil, required: true, placeholder: "Describe your photography services...", maxlength: 500 %>
                <div class="char-counter"><span id="desc-count">0</span>/500</div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>Contact Information</h3>

            <div class="form-row">
              <div class="form-field">
                <label for="email">Email</label>
                <%= email_field_tag "business_listing[email]", nil, placeholder: "contact@yourbusiness.com" %>
              </div>

              <div class="form-field">
                <label for="phone">Phone</label>
                <%= telephone_field_tag "business_listing[phone]", nil, placeholder: "+44 123 456 7890" %>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>Social Media (Optional)</h3>

            <div class="form-row">
              <div class="form-field">
                <label for="instagram">Instagram</label>
                <%= text_field_tag "business_listing[instagram]", nil, placeholder: "https://instagram.com/yourprofile" %>
              </div>

              <div class="form-field">
                <label for="facebook">Facebook</label>
                <%= text_field_tag "business_listing[facebook]", nil, placeholder: "https://facebook.com/yourpage" %>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label for="tiktok">TikTok</label>
                <%= text_field_tag "business_listing[tiktok]", nil, placeholder: "https://tiktok.com/@yourprofile" %>
              </div>
              <div class="form-field"></div>
            </div>
          </div>

          <div class="form-actions">
            <%= link_to "Cancel", "/directory", class: "btn btn-default" %>
            <%= submit_tag "Create Listing", class: "btn btn-primary", id: "submit-listing" %>
          </div>

          <div id="form-message" class="form-message" style="display: none;"></div>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Character counter for description
  const descField = document.querySelector('textarea[name="business_listing[description]"]');
  const descCount = document.getElementById('desc-count');

  if (descField && descCount) {
    descField.addEventListener('input', function() {
      descCount.textContent = this.value.length;
    });
  }

  // Handle form submission
  const form = document.getElementById('create-listing-form');
  const submitBtn = document.getElementById('submit-listing');
  const messageDiv = document.getElementById('form-message');

  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.value = 'Creating...';

      // Get form data
      const formData = new FormData(form);

      // Send AJAX request
      fetch('/my-business', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          messageDiv.className = 'form-message success';
          messageDiv.textContent = data.message || 'Listing created successfully!';
          messageDiv.style.display = 'block';

          // Reload page after 2 seconds to show the listing
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          messageDiv.className = 'form-message error';
          messageDiv.textContent = data.errors ? data.errors.join(', ') : 'An error occurred';
          messageDiv.style.display = 'block';

          submitBtn.disabled = false;
          submitBtn.value = 'Create Listing';
        }
      })
      .catch(error => {
        messageDiv.className = 'form-message error';
        messageDiv.textContent = 'Network error. Please try again.';
        messageDiv.style.display = 'block';

        submitBtn.disabled = false;
        submitBtn.value = 'Create Listing';
      });
    });
  }
});
</script>

<style>
.subscription-required {
  padding: 3rem 1rem;
}

.subscription-message {
  max-width: 600px;
  margin: 0 auto;
  padding: 3rem;
  border: 1px solid var(--primary-low);
  border-radius: 12px;
  background: var(--tertiary-very-low);
  text-align: center;
}

.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;

  &.approved {
    background: #d4edda;
    color: #155724;
  }

  &.pending {
    background: #fff3cd;
    color: #856404;
  }
}

.listing-summary {
  margin-top: 2rem;
}

.summary-card {
  background: var(--secondary);
  border: 1px solid var(--primary-low);
  border-radius: 12px;
  padding: 2rem;

  h3 {
    margin: 0 0 1.5rem 0;
    color: var(--primary);
    font-size: 1.5rem;
  }

  h4 {
    margin: 1.5rem 0 1rem 0;
    color: var(--primary);
    font-size: 1.2rem;
  }
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;

  strong {
    color: var(--primary-medium);
    font-size: 0.9rem;
    font-weight: 600;
  }

  span {
    color: var(--primary);
    font-size: 1rem;
  }
}

.description-section {
  margin: 2rem 0;
  padding: 1.5rem;
  background: var(--tertiary-very-low);
  border-radius: 8px;

  p {
    margin: 0;
    line-height: 1.6;
    color: var(--primary);
  }
}

.images-section {
  margin: 2rem 0;
}

.packages-section {
  margin: 2rem 0;
}

.package-item-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  background: var(--tertiary-very-low);
  border-radius: 8px;
  margin-bottom: 0.5rem;

  strong {
    color: var(--primary);
  }

  .package-price {
    color: var(--tertiary);
    font-weight: 700;
    font-size: 1.1rem;
  }
}

.management-notice {
  margin-top: 2rem;
  padding: 1.5rem;
  background: var(--highlight-bg);
  border: 1px solid var(--primary-low);
  border-radius: 8px;

  p {
    margin: 0.5rem 0;
    color: var(--primary-medium);
  }

  code {
    background: var(--secondary);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    color: var(--tertiary);
  }
}

.create-notice {
  margin-top: 2rem;
  padding: 2rem;
  background: var(--tertiary-very-low);
  border-radius: 8px;

  p {
    margin: 0.75rem 0;
    color: var(--primary-medium);
  }

  .mt-2 {
    margin-top: 1.5rem;
  }

  code {
    background: var(--secondary);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    color: var(--tertiary);
    font-weight: 600;
  }
}

.create-listing-section {
  max-width: 900px;
  margin: 0 auto;
}

.form-intro {
  text-align: center;
  margin-bottom: 3rem;

  .no-listings-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  h3 {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--primary);
  }

  p {
    font-size: 1.1rem;
    color: var(--primary-medium);
  }
}

.form-message {
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin-top: 1.5rem;
  font-weight: 500;
  text-align: center;

  &.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  &.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
}
</style>
